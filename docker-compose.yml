version: "3.9"

services:
  adaptiv-controller-github:
    build: .
    image: adaptiv-controller-github:local
    container_name: adaptiv-controller-github
    environment:
      # -----------------------------------------------------------------
      # Core GitHub authentication
      # -----------------------------------------------------------------
      GITHUB_PAT: "${GITHUB_PAT}"
      GITHUB_TOKEN: "${GITHUB_TOKEN}"
      GITHUB_API_BASE: "${GITHUB_API_BASE}"

      # -----------------------------------------------------------------
      # Controller repo / contract configuration
      # -----------------------------------------------------------------
      GITHUB_MCP_CONTROLLER_REPO: "${GITHUB_MCP_CONTROLLER_REPO}"
      GITHUB_MCP_CONTROLLER_CONTRACT_VERSION: "${GITHUB_MCP_CONTROLLER_CONTRACT_VERSION}"
      GITHUB_MCP_CONTROLLER_BRANCH: "${GITHUB_MCP_CONTROLLER_BRANCH}"
      GITHUB_MCP_AUTO_APPROVE: "${GITHUB_MCP_AUTO_APPROVE}"

      # -----------------------------------------------------------------
      # Workspace and execution configuration
      # -----------------------------------------------------------------
      MCP_WORKSPACE_BASE_DIR: "${MCP_WORKSPACE_BASE_DIR}"

      # -----------------------------------------------------------------
      # HTTP client tuning (GitHub and external)
      # -----------------------------------------------------------------
      HTTPX_TIMEOUT: "${HTTPX_TIMEOUT}"
      HTTPX_MAX_CONNECTIONS: "${HTTPX_MAX_CONNECTIONS}"
      HTTPX_MAX_KEEPALIVE: "${HTTPX_MAX_KEEPALIVE}"
      HTTPX_HTTP2: "${HTTPX_HTTP2}"
      MAX_CONCURRENCY: "${MAX_CONCURRENCY}"
      FETCH_FILES_CONCURRENCY: "${FETCH_FILES_CONCURRENCY}"

      # -----------------------------------------------------------------
      # Git identity for commits
      # -----------------------------------------------------------------
      GIT_AUTHOR_NAME: "${GIT_AUTHOR_NAME}"
      GIT_AUTHOR_EMAIL: "${GIT_AUTHOR_EMAIL}"
      GIT_COMMITTER_NAME: "${GIT_COMMITTER_NAME}"
      GIT_COMMITTER_EMAIL: "${GIT_COMMITTER_EMAIL}"

      # -----------------------------------------------------------------
      # Tool output truncation (stdout/stderr)
      # -----------------------------------------------------------------
      TOOL_STDOUT_MAX_CHARS: "${TOOL_STDOUT_MAX_CHARS}"
      TOOL_STDERR_MAX_CHARS: "${TOOL_STDERR_MAX_CHARS}"
      TOOL_STDIO_COMBINED_MAX_CHARS: "${TOOL_STDIO_COMBINED_MAX_CHARS}"

      # -----------------------------------------------------------------
      # Logging configuration
      # -----------------------------------------------------------------
      LOG_LEVEL: "${LOG_LEVEL}"
      LOG_FORMAT: "${LOG_FORMAT}"

      # -----------------------------------------------------------------
      # Sandbox / content rewrite configuration
      # -----------------------------------------------------------------
      SANDBOX_CONTENT_BASE_URL: "${SANDBOX_CONTENT_BASE_URL}"

      # -----------------------------------------------------------------
      # Process-level settings
      # -----------------------------------------------------------------
      PORT: "${PORT}"

    ports:
      - "8000:8000"
    volumes:
      - ./workspace:/workspace
    restart: unless-stopped
